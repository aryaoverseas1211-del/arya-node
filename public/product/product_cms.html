<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>Arya Overseas CMS</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="/assets/theme.css">
<style>
  .hidden-section { display: none; }
  .tab-active { background: #0f766e; color: #fff; }
  .table-row:hover { background: rgba(15, 118, 110, 0.05); }
</style>
</head>
<body class="bg-slate-100 min-h-screen">

<header class="bg-slate-900 text-white px-6 py-4 shadow-lg">
  <div class="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-bold">Arya Overseas CMS</h1>
      <p class="text-sm text-slate-300">Inventory, Categories, Products & Admin Management</p>
    </div>
    <div class="flex items-center gap-3">
      <span id="adminInfo" class="text-sm text-slate-200"></span>
      <button id="logoutBtn" class="bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg text-sm font-semibold">Logout</button>
      <a href="/" class="text-sm underline text-slate-200">View Website</a>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <div id="message" class="mb-4"></div>

  <div class="flex flex-wrap gap-2 mb-6">
    <button class="tab-btn tab-active px-4 py-2 rounded-lg text-sm font-semibold" data-tab="products">Products</button>
    <button class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold" data-tab="categories">Categories</button>
    <button class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold" data-tab="inventory">Inventory</button>
    <button class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold" data-tab="imports">Import/Export</button>
    <button class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold" data-tab="audit">Audit Log</button>
    <button class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold" data-tab="admins">Admins</button>
  </div>

  <!-- PRODUCTS TAB -->
  <section id="tab-products">
    <div class="grid lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1 bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Product Editor</h2>
        <form id="productForm" class="space-y-4">
          <input type="hidden" id="productId">
          <div>
            <label class="text-sm font-medium">Title *</label>
            <input id="title" type="text" class="w-full border rounded-lg p-2" required>
          </div>
          <div>
            <label class="text-sm font-medium">Short Description</label>
            <input id="shortDesc" type="text" class="w-full border rounded-lg p-2">
          </div>
          <div>
            <label class="text-sm font-medium">Description *</label>
            <textarea id="description" rows="4" class="w-full border rounded-lg p-2" required></textarea>
          </div>
          <div>
            <label class="text-sm font-medium">Category</label>
            <select id="categoryId" class="w-full border rounded-lg p-2"></select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">Status</label>
              <select id="status" class="w-full border rounded-lg p-2">
                <option value="draft">Draft</option>
                <option value="published">Published</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">Low Stock Threshold</label>
              <input id="lowStock" type="number" min="0" class="w-full border rounded-lg p-2">
            </div>
          </div>
          <div>
            <label class="text-sm font-medium">Product Image</label>
            <input id="imageUpload" type="file" accept="image/*" class="w-full border rounded-lg p-2">
            <p class="text-xs text-slate-500">Required for new products.</p>
          </div>

          <div>
            <label class="text-sm font-medium">MOQ Pricing Tiers</label>
            <div id="pricingTiers" class="space-y-2 mt-2"></div>
            <button type="button" id="addPricingTier" class="text-sm text-emerald-600 mt-2">+ Add Pricing Tier</button>
          </div>

          <div>
            <label class="text-sm font-medium">Variants (Inventory)</label>
            <div id="variantList" class="space-y-2 mt-2"></div>
            <button type="button" id="addVariant" class="text-sm text-emerald-600 mt-2">+ Add Variant</button>
          </div>

          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-semibold">Save</button>
            <button type="button" id="resetProduct" class="flex-1 border border-slate-300 py-2 rounded-lg">Clear</button>
          </div>
        </form>
      </div>

      <div class="lg:col-span-2 bg-white rounded-2xl shadow p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <h2 class="text-xl font-bold">Products</h2>
          <div class="flex gap-2">
            <input id="searchProducts" type="text" placeholder="Search..." class="border rounded-lg p-2 text-sm">
            <select id="filterCategory" class="border rounded-lg p-2 text-sm"></select>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 mb-4">
          <button id="bulkPublish" class="px-3 py-1 text-sm border rounded">Publish</button>
          <button id="bulkUnpublish" class="px-3 py-1 text-sm border rounded">Unpublish</button>
          <button id="bulkDelete" class="px-3 py-1 text-sm border rounded text-red-600">Delete</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500">
                <th class="p-2"><input type="checkbox" id="selectAll"></th>
                <th class="p-2">Product</th>
                <th class="p-2">Category</th>
                <th class="p-2">Status</th>
                <th class="p-2">Stock</th>
                <th class="p-2">Actions</th>
              </tr>
            </thead>
            <tbody id="productTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- CATEGORIES TAB -->
  <section id="tab-categories" class="hidden-section">
    <div class="grid lg:grid-cols-3 gap-6">
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Category Editor</h2>
        <form id="categoryForm" class="space-y-3">
          <input type="hidden" id="categoryEditId">
          <div>
            <label class="text-sm font-medium">Name *</label>
            <input id="categoryName" type="text" class="w-full border rounded-lg p-2" required>
          </div>
          <div>
            <label class="text-sm font-medium">Slug</label>
            <input id="categorySlug" type="text" class="w-full border rounded-lg p-2">
          </div>
          <div>
            <label class="text-sm font-medium">Description</label>
            <textarea id="categoryDesc" rows="3" class="w-full border rounded-lg p-2"></textarea>
          </div>
          <div>
            <label class="text-sm font-medium">Banner Title</label>
            <input id="bannerTitle" type="text" class="w-full border rounded-lg p-2">
          </div>
          <div>
            <label class="text-sm font-medium">Banner Subtitle</label>
            <input id="bannerSubtitle" type="text" class="w-full border rounded-lg p-2">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">CTA Text</label>
              <input id="bannerCtaText" type="text" class="w-full border rounded-lg p-2">
            </div>
            <div>
              <label class="text-sm font-medium">CTA URL</label>
              <input id="bannerCtaUrl" type="text" class="w-full border rounded-lg p-2">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">Sort Order</label>
              <input id="categorySort" type="number" class="w-full border rounded-lg p-2">
            </div>
            <div>
              <label class="text-sm font-medium">Active</label>
              <select id="categoryActive" class="w-full border rounded-lg p-2">
                <option value="1">Yes</option>
                <option value="0">No</option>
              </select>
            </div>
          </div>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-emerald-600 text-white py-2 rounded-lg">Save</button>
            <button type="button" id="resetCategory" class="flex-1 border border-slate-300 py-2 rounded-lg">Clear</button>
          </div>
        </form>
      </div>
      <div class="lg:col-span-2 bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Categories</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500">
                <th class="p-2">Name</th>
                <th class="p-2">Slug</th>
                <th class="p-2">Active</th>
                <th class="p-2">Actions</th>
              </tr>
            </thead>
            <tbody id="categoryTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- INVENTORY TAB -->
  <section id="tab-inventory" class="hidden-section">
    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-4">Inventory</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500">
              <th class="p-2">Product</th>
              <th class="p-2">SKU</th>
              <th class="p-2">Attributes</th>
              <th class="p-2">Stock</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="inventoryTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- IMPORTS TAB -->
  <section id="tab-imports" class="hidden-section">
    <div class="grid md:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Export</h2>
        <div class="space-y-3">
          <button onclick="exportData('json','full')" class="w-full bg-emerald-600 text-white py-2 rounded-lg">Export Full JSON</button>
          <button onclick="exportData('csv','products')" class="w-full border py-2 rounded-lg">Export Products CSV</button>
          <button onclick="exportData('csv','variants')" class="w-full border py-2 rounded-lg">Export Variants CSV</button>
          <button onclick="exportData('csv','inventory')" class="w-full border py-2 rounded-lg">Export Inventory CSV</button>
          <button onclick="exportData('csv','categories')" class="w-full border py-2 rounded-lg">Export Categories CSV</button>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Import</h2>
        <form id="importForm" class="space-y-3">
          <select id="importFormat" class="w-full border rounded-lg p-2">
            <option value="json">JSON (Full export)</option>
            <option value="csv">CSV (Products only)</option>
          </select>
          <input id="importFile" type="file" class="w-full border rounded-lg p-2">
          <button type="submit" class="w-full bg-emerald-600 text-white py-2 rounded-lg">Import</button>
          <p class="text-xs text-slate-500">CSV import supports products only. JSON import supports full export file.</p>
        </form>
      </div>
    </div>
  </section>

  <!-- AUDIT TAB -->
  <section id="tab-audit" class="hidden-section">
    <div class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-4">Audit Log</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500">
              <th class="p-2">Time</th>
              <th class="p-2">Admin</th>
              <th class="p-2">Action</th>
              <th class="p-2">Entity</th>
              <th class="p-2">Details</th>
            </tr>
          </thead>
          <tbody id="auditTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ADMINS TAB -->
  <section id="tab-admins" class="hidden-section">
    <div class="grid md:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Create Admin</h2>
        <form id="adminForm" class="space-y-3">
          <input id="adminName" type="text" placeholder="Name" class="w-full border rounded-lg p-2">
          <input id="adminEmail" type="email" placeholder="Email" class="w-full border rounded-lg p-2" required>
          <input id="adminPassword" type="password" placeholder="Password" class="w-full border rounded-lg p-2" required>
          <button type="submit" class="w-full bg-emerald-600 text-white py-2 rounded-lg">Create Admin</button>
        </form>
      </div>
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">Admins</h2>
        <div id="adminList" class="space-y-2"></div>
      </div>
    </div>
  </section>
</main>

<!-- STOCK MODAL -->
<div id="stockModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
  <div class="bg-white rounded-2xl p-6 w-full max-w-md">
    <h3 class="text-lg font-bold mb-4">Adjust Stock</h3>
    <input type="hidden" id="stockVariantId">
    <div class="space-y-3">
      <input id="stockDelta" type="number" placeholder="Delta (e.g., 10 or -5)" class="w-full border rounded-lg p-2">
      <input id="stockReason" type="text" placeholder="Reason" class="w-full border rounded-lg p-2">
      <div class="flex gap-2">
        <button id="applyStock" class="flex-1 bg-emerald-600 text-white py-2 rounded-lg">Apply</button>
        <button id="closeStock" class="flex-1 border rounded-lg py-2">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
const state = {
  categories: [],
  products: [],
  variants: [],
  admins: [],
  audit: []
};

const API = '';
const messageBox = document.getElementById('message');

function showMessage(text, type = 'success') {
  messageBox.innerHTML = `
    <div class="${type === 'error' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-emerald-100 text-emerald-700 border-emerald-200'} border px-4 py-3 rounded-lg">
      ${text}
    </div>
  `;
  setTimeout(() => { messageBox.innerHTML = ''; }, 4000);
}

async function fetchJSON(url, options) {
  const res = await fetch(url, options);
  const data = await res.json();
  if (!data.success) throw new Error(data.message || 'Request failed');
  return data;
}

async function loadAdmin() {
  const res = await fetch('/api/admin/me');
  if (res.status === 401) {
    window.location.href = '/admin/login';
    return;
  }
  const data = await res.json();
  document.getElementById('adminInfo').textContent = data.admin?.email || '';
}

async function loadAll() {
  await loadAdmin();
  await Promise.all([loadCategories(), loadProducts(), loadVariants(), loadAdmins(), loadAudit()]);
}

async function loadCategories() {
  const data = await fetchJSON('/api/admin/categories');
  state.categories = data.categories;
  renderCategorySelects();
  renderCategoryTable();
}

async function loadProducts() {
  const data = await fetchJSON('/api/admin/products');
  state.products = data.products;
  renderProductTable();
}

async function loadVariants() {
  const data = await fetchJSON('/api/admin/variants');
  state.variants = data.variants;
  renderInventoryTable();
}

async function loadAdmins() {
  const data = await fetchJSON('/api/admin/admins');
  state.admins = data.admins;
  renderAdminList();
}

async function loadAudit() {
  const data = await fetchJSON('/api/admin/audit');
  state.audit = data.entries;
  renderAuditTable();
}

function renderCategorySelects() {
  const select = document.getElementById('categoryId');
  const filter = document.getElementById('filterCategory');
  select.innerHTML = '<option value="">Uncategorized</option>';
  filter.innerHTML = '<option value="">All Categories</option>';
  state.categories.forEach(cat => {
    const option = `<option value="${cat.id}">${cat.name}</option>`;
    select.insertAdjacentHTML('beforeend', option);
    filter.insertAdjacentHTML('beforeend', option);
  });
}

function renderCategoryTable() {
  const tbody = document.getElementById('categoryTable');
  tbody.innerHTML = '';
  state.categories.forEach(cat => {
    const row = document.createElement('tr');
    row.className = 'table-row';
    row.innerHTML = `
      <td class="p-2 font-medium">${cat.name}</td>
      <td class="p-2 text-slate-500">${cat.slug}</td>
      <td class="p-2">${cat.is_active ? 'Yes' : 'No'}</td>
      <td class="p-2">
        <button class="text-emerald-600 text-sm" onclick="editCategory(${cat.id})">Edit</button>
        <button class="text-red-600 text-sm ml-2" onclick="deleteCategory(${cat.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function renderProductTable() {
  const tbody = document.getElementById('productTable');
  const query = document.getElementById('searchProducts').value.toLowerCase();
  const categoryFilter = document.getElementById('filterCategory').value;

  tbody.innerHTML = '';
  state.products
    .filter(p => (!query || p.title.toLowerCase().includes(query)))
    .filter(p => (!categoryFilter || String(p.categoryId) === String(categoryFilter)))
    .forEach(p => {
      const row = document.createElement('tr');
      row.className = 'table-row';
      row.innerHTML = `
        <td class="p-2"><input type="checkbox" class="product-check" value="${p.id}"></td>
        <td class="p-2">
          <div class="font-medium">${p.title}</div>
          <div class="text-xs text-slate-500">${p.shortDesc || ''}</div>
        </td>
        <td class="p-2 text-slate-500">${p.category?.name || '-'}</td>
        <td class="p-2">
          <span class="px-2 py-1 rounded-full text-xs ${p.status === 'published' ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700'}">${p.status}</span>
        </td>
        <td class="p-2 text-slate-500">${p.stockTotal ?? 0}</td>
        <td class="p-2">
          <button class="text-emerald-600 text-sm" onclick="editProduct(${p.id})">Edit</button>
          <button class="text-red-600 text-sm ml-2" onclick="deleteProduct(${p.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
}

function renderInventoryTable() {
  const tbody = document.getElementById('inventoryTable');
  tbody.innerHTML = '';
  state.variants.forEach(v => {
    const attrText = Object.entries(v.attributes || {}).map(([k,val]) => `${k}: ${val}`).join(', ');
    const lowStock = v.lowStockThreshold !== null && v.lowStockThreshold !== undefined && v.stockQty <= v.lowStockThreshold;
    const row = document.createElement('tr');
    row.className = 'table-row';
    row.innerHTML = `
      <td class="p-2">${v.productTitle}</td>
      <td class="p-2">${v.sku || '-'}</td>
      <td class="p-2 text-slate-500">${attrText || '-'}</td>
      <td class="p-2 ${lowStock ? 'text-red-600 font-semibold' : ''}">${v.stockQty}</td>
      <td class="p-2">
        <button class="text-emerald-600 text-sm" onclick="openStockModal(${v.id})">Adjust</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function renderAuditTable() {
  const tbody = document.getElementById('auditTable');
  tbody.innerHTML = '';
  state.audit.forEach(entry => {
    const row = document.createElement('tr');
    row.className = 'table-row';
    row.innerHTML = `
      <td class="p-2 text-xs text-slate-500">${new Date(entry.created_at).toLocaleString()}</td>
      <td class="p-2 text-xs">${entry.admin_email || '-'}</td>
      <td class="p-2 text-xs">${entry.action}</td>
      <td class="p-2 text-xs">${entry.entity}</td>
      <td class="p-2 text-xs text-slate-500">${entry.details_json || ''}</td>
    `;
    tbody.appendChild(row);
  });
}

function renderAdminList() {
  const list = document.getElementById('adminList');
  list.innerHTML = '';
  state.admins.forEach(admin => {
    const item = document.createElement('div');
    item.className = 'border rounded-lg p-3 flex justify-between items-center';
    item.innerHTML = `
      <div>
        <div class="font-medium">${admin.name || 'Admin'}</div>
        <div class="text-xs text-slate-500">${admin.email}</div>
      </div>
      <button class="text-red-600 text-sm" onclick="deleteAdmin(${admin.id})">Delete</button>
    `;
    list.appendChild(item);
  });
}

function addPricingTierRow(tier = {}) {
  const container = document.getElementById('pricingTiers');
  const row = document.createElement('div');
  row.className = 'grid grid-cols-3 gap-2';
  row.innerHTML = `
    <input type="number" class="border rounded-lg p-2 tier-min" placeholder="Min" value="${tier.min || ''}">
    <input type="number" class="border rounded-lg p-2 tier-max" placeholder="Max" value="${tier.max || ''}">
    <div class="flex gap-2">
      <input type="number" class="border rounded-lg p-2 tier-price" placeholder="Price" value="${tier.price || ''}">
      <button type="button" class="text-red-600" onclick="this.parentElement.parentElement.remove()">âœ•</button>
    </div>
  `;
  container.appendChild(row);
}

function addVariantRow(variant = {}) {
  const container = document.getElementById('variantList');
  const row = document.createElement('div');
  row.className = 'grid grid-cols-2 gap-2 items-start border rounded-lg p-2';
  row.innerHTML = `
    <div class="space-y-2">
      <input type="text" class="border rounded-lg p-2 variant-sku" placeholder="SKU" value="${variant.sku || ''}">
      <input type="text" class="border rounded-lg p-2 variant-size" placeholder="Size" value="${variant.attributes?.size || ''}">
      <input type="text" class="border rounded-lg p-2 variant-color" placeholder="Color" value="${variant.attributes?.color || ''}">
      <input type="text" class="border rounded-lg p-2 variant-custom" placeholder="Custom attribute" value="${variant.attributes?.custom || ''}">
    </div>
    <div class="space-y-2">
      <input type="number" class="border rounded-lg p-2 variant-price" placeholder="Price" value="${variant.price ?? ''}">
      <input type="number" class="border rounded-lg p-2 variant-stock" placeholder="Stock" value="${variant.stockQty ?? 0}">
      <select class="border rounded-lg p-2 variant-active">
        <option value="1" ${variant.isActive !== false ? 'selected' : ''}>Active</option>
        <option value="0" ${variant.isActive === false ? 'selected' : ''}>Inactive</option>
      </select>
      <button type="button" class="text-red-600 text-sm" onclick="this.parentElement.parentElement.remove()">Remove</button>
    </div>
  `;
  container.appendChild(row);
}

function collectPricingTiers() {
  return Array.from(document.querySelectorAll('#pricingTiers > div')).map(row => {
    const min = Number(row.querySelector('.tier-min').value) || 0;
    const max = row.querySelector('.tier-max').value ? Number(row.querySelector('.tier-max').value) : null;
    const price = Number(row.querySelector('.tier-price').value) || 0;
    if (!min || !price) return null;
    return { min, max, price };
  }).filter(Boolean);
}

function collectVariants() {
  return Array.from(document.querySelectorAll('#variantList > div')).map(row => {
    const attributes = {
      size: row.querySelector('.variant-size').value.trim(),
      color: row.querySelector('.variant-color').value.trim(),
      custom: row.querySelector('.variant-custom').value.trim()
    };
    Object.keys(attributes).forEach(key => {
      if (!attributes[key]) delete attributes[key];
    });
    return {
      sku: row.querySelector('.variant-sku').value.trim(),
      attributes,
      price: row.querySelector('.variant-price').value,
      stockQty: row.querySelector('.variant-stock').value,
      isActive: row.querySelector('.variant-active').value === '1'
    };
  });
}

async function editProduct(id) {
  const res = await fetch(`/api/admin/products/${id}`);
  const data = await res.json();
  if (!data.success) {
    showMessage(data.message || 'Unable to load product', 'error');
    return;
  }
  const product = data.product;
  document.getElementById('productId').value = product.id;
  document.getElementById('title').value = product.title;
  document.getElementById('shortDesc').value = product.shortDesc || '';
  document.getElementById('description').value = product.description || '';
  document.getElementById('categoryId').value = product.categoryId || '';
  document.getElementById('status').value = product.status || 'draft';
  document.getElementById('lowStock').value = product.lowStockThreshold || '';

  document.getElementById('pricingTiers').innerHTML = '';
  if (product.pricing && product.pricing.length) {
    product.pricing.forEach(addPricingTierRow);
  } else {
    addPricingTierRow();
  }

  document.getElementById('variantList').innerHTML = '';
  if (product.variants && product.variants.length) {
    product.variants.forEach(addVariantRow);
  } else {
    addVariantRow();
  }

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function deleteProduct(id) {
  if (!confirm('Delete this product?')) return;
  try {
    await fetchJSON(`/api/admin/products/${id}`, { method: 'DELETE' });
    showMessage('Product deleted');
    await loadProducts();
  } catch (err) {
    showMessage(err.message, 'error');
  }
}

async function editCategory(id) {
  const cat = state.categories.find(c => String(c.id) === String(id));
  if (!cat) return;
  document.getElementById('categoryEditId').value = cat.id;
  document.getElementById('categoryName').value = cat.name;
  document.getElementById('categorySlug').value = cat.slug;
  document.getElementById('categoryDesc').value = cat.description || '';
  document.getElementById('bannerTitle').value = cat.banner_title || '';
  document.getElementById('bannerSubtitle').value = cat.banner_subtitle || '';
  document.getElementById('bannerCtaText').value = cat.banner_cta_text || '';
  document.getElementById('bannerCtaUrl').value = cat.banner_cta_url || '';
  document.getElementById('categorySort').value = cat.sort_order || 0;
  document.getElementById('categoryActive').value = cat.is_active ? '1' : '0';
}

async function deleteCategory(id) {
  if (!confirm('Delete this category? Products will become uncategorized.')) return;
  try {
    await fetchJSON(`/api/admin/categories/${id}`, { method: 'DELETE' });
    showMessage('Category deleted');
    await loadCategories();
    await loadProducts();
  } catch (err) {
    showMessage(err.message, 'error');
  }
}

async function deleteAdmin(id) {
  if (!confirm('Delete this admin?')) return;
  try {
    await fetchJSON(`/api/admin/admins/${id}`, { method: 'DELETE' });
    showMessage('Admin deleted');
    await loadAdmins();
  } catch (err) {
    showMessage(err.message, 'error');
  }
}

function openStockModal(id) {
  document.getElementById('stockVariantId').value = id;
  document.getElementById('stockDelta').value = '';
  document.getElementById('stockReason').value = '';
  document.getElementById('stockModal').classList.remove('hidden');
  document.getElementById('stockModal').classList.add('flex');
}

function closeStockModal() {
  document.getElementById('stockModal').classList.add('hidden');
  document.getElementById('stockModal').classList.remove('flex');
}

async function applyStock() {
  const id = document.getElementById('stockVariantId').value;
  const delta = document.getElementById('stockDelta').value;
  const reason = document.getElementById('stockReason').value;
  try {
    await fetchJSON(`/api/admin/variants/${id}/adjust-stock`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ delta, reason })
    });
    showMessage('Stock adjusted');
    closeStockModal();
    await loadVariants();
  } catch (err) {
    showMessage(err.message, 'error');
  }
}

async function exportData(format, type) {
  window.location.href = `/api/admin/export?format=${format}&type=${type}`;
}

// Event bindings

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await fetchJSON('/api/admin/logout', { method: 'POST' });
  window.location.href = '/admin/login';
});

// Tabs

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
    btn.classList.add('tab-active');
    document.querySelectorAll('main section').forEach(section => section.classList.add('hidden-section'));
    document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden-section');
  });
});

// Product form

document.getElementById('addPricingTier').addEventListener('click', () => addPricingTierRow());
document.getElementById('addVariant').addEventListener('click', () => addVariantRow());

document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('productId').value;

  const formData = new FormData();
  formData.append('title', document.getElementById('title').value.trim());
  formData.append('shortDesc', document.getElementById('shortDesc').value.trim());
  formData.append('description', document.getElementById('description').value.trim());
  formData.append('categoryId', document.getElementById('categoryId').value);
  formData.append('status', document.getElementById('status').value);
  formData.append('lowStockThreshold', document.getElementById('lowStock').value);
  formData.append('pricing', JSON.stringify(collectPricingTiers()));
  formData.append('variants', JSON.stringify(collectVariants()));

  const imageFile = document.getElementById('imageUpload').files[0];
  if (imageFile) {
    formData.append('image', imageFile);
  }

  try {
    if (id) {
      await fetchJSON(`/api/admin/products/${id}`, { method: 'PUT', body: formData });
      showMessage('Product updated');
    } else {
      await fetchJSON('/api/admin/products', { method: 'POST', body: formData });
      showMessage('Product created');
    }
    resetProductForm();
    await loadProducts();
    await loadVariants();
  } catch (err) {
    showMessage(err.message, 'error');
  }
});

function resetProductForm() {
  document.getElementById('productId').value = '';
  document.getElementById('productForm').reset();
  document.getElementById('pricingTiers').innerHTML = '';
  document.getElementById('variantList').innerHTML = '';
  addPricingTierRow();
  addVariantRow();
}

document.getElementById('resetProduct').addEventListener('click', resetProductForm);

// Category form

document.getElementById('categoryForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('categoryEditId').value;
  const payload = {
    name: document.getElementById('categoryName').value.trim(),
    slug: document.getElementById('categorySlug').value.trim(),
    description: document.getElementById('categoryDesc').value.trim(),
    banner_title: document.getElementById('bannerTitle').value.trim(),
    banner_subtitle: document.getElementById('bannerSubtitle').value.trim(),
    banner_cta_text: document.getElementById('bannerCtaText').value.trim(),
    banner_cta_url: document.getElementById('bannerCtaUrl').value.trim(),
    sort_order: document.getElementById('categorySort').value,
    is_active: document.getElementById('categoryActive').value === '1'
  };
  try {
    if (id) {
      await fetchJSON(`/api/admin/categories/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      showMessage('Category updated');
    } else {
      await fetchJSON('/api/admin/categories', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      showMessage('Category created');
    }
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryEditId').value = '';
    await loadCategories();
  } catch (err) {
    showMessage(err.message, 'error');
  }
});

document.getElementById('resetCategory').addEventListener('click', () => {
  document.getElementById('categoryForm').reset();
  document.getElementById('categoryEditId').value = '';
});

// Bulk actions

document.getElementById('selectAll').addEventListener('change', (e) => {
  document.querySelectorAll('.product-check').forEach(cb => cb.checked = e.target.checked);
});

document.getElementById('bulkPublish').addEventListener('click', () => bulkUpdateStatus('published'));
document.getElementById('bulkUnpublish').addEventListener('click', () => bulkUpdateStatus('draft'));
document.getElementById('bulkDelete').addEventListener('click', bulkDeleteProducts);

async function bulkUpdateStatus(status) {
  const ids = Array.from(document.querySelectorAll('.product-check:checked')).map(cb => cb.value);
  if (!ids.length) return;
  for (const id of ids) {
    await fetchJSON(`/api/admin/products/${id}/publish`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
  }
  showMessage('Products updated');
  await loadProducts();
}

async function bulkDeleteProducts() {
  const ids = Array.from(document.querySelectorAll('.product-check:checked')).map(cb => cb.value);
  if (!ids.length) return;
  if (!confirm('Delete selected products?')) return;
  for (const id of ids) {
    await fetchJSON(`/api/admin/products/${id}`, { method: 'DELETE' });
  }
  showMessage('Products deleted');
  await loadProducts();
}

// Search/filter

document.getElementById('searchProducts').addEventListener('input', renderProductTable);
document.getElementById('filterCategory').addEventListener('change', renderProductTable);

// Import

document.getElementById('importForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const format = document.getElementById('importFormat').value;
  const file = document.getElementById('importFile').files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append('file', file);

  try {
    await fetchJSON(`/api/admin/import?format=${format}`, { method: 'POST', body: formData });
    showMessage('Import completed');
    await loadAll();
  } catch (err) {
    showMessage(err.message, 'error');
  }
});

// Admin form

document.getElementById('adminForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    name: document.getElementById('adminName').value.trim(),
    email: document.getElementById('adminEmail').value.trim(),
    password: document.getElementById('adminPassword').value.trim()
  };
  try {
    await fetchJSON('/api/admin/admins', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    showMessage('Admin created');
    document.getElementById('adminForm').reset();
    await loadAdmins();
  } catch (err) {
    showMessage(err.message, 'error');
  }
});

// Stock modal

document.getElementById('applyStock').addEventListener('click', applyStock);
document.getElementById('closeStock').addEventListener('click', closeStockModal);

// Init
addPricingTierRow();
addVariantRow();
loadAll();
</script>
</body>
</html>
