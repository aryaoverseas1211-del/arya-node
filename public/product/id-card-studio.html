<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arya Studio | ID Card Suite</title>
<link rel="icon" type="image/png" href="/assets/veom-logo.png">
<link rel="apple-touch-icon" href="/assets/veom-logo.png">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="/assets/theme.css">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body { background: linear-gradient(180deg, #f4f8ff, #eef2f7); }
  .panel { background: #fff; border: 1px solid #dbe7f7; border-radius: 16px; box-shadow: 0 12px 26px rgba(15, 40, 85, 0.08); }
  .input { width: 100%; border: 1px solid #c7d6ee; border-radius: 10px; padding: 10px 12px; font-size: 14px; }
  .label { font-size: 12px; font-weight: 700; color: #334155; margin-bottom: 6px; display: block; }
  .btn { border-radius: 10px; font-weight: 700; font-size: 14px; padding: 10px 12px; min-height: 44px; }
  .btn-primary { background: #1d4ed8; color: #fff; }
  .btn-subtle { background: #f1f5f9; color: #0f172a; border: 1px solid #dbe7f7; }
  .canvas-wrap { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; }
  .data-table th, .data-table td { border-bottom: 1px solid #e2e8f0; padding: 6px 8px; font-size: 12px; text-align: left; }
  .data-table th { font-weight: 700; color: #334155; background: #f8fafc; position: sticky; top: 0; }
</style>
</head>
<body class="text-slate-900">

<main class="max-w-7xl mx-auto px-5 py-8">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-blue-900">Arya Studio ID Card Suite</h1>
    <p class="text-slate-600 mt-1">School and enterprise ID card production with bulk CSV, live preview, and print-ready sheets.</p>
  </div>

  <div class="grid xl:grid-cols-[1.1fr_1fr] gap-6">
    <section class="panel p-5">
      <h2 class="text-lg font-bold mb-4">Card Configuration</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="label">Template</label>
          <select id="template" class="input">
            <option value="corporate">Corporate</option>
            <option value="student">Student</option>
            <option value="visitor">Visitor</option>
          </select>
        </div>
        <div>
          <label class="label">Quantity</label>
          <input id="quantity" class="input" type="number" min="1" value="24">
        </div>
        <div>
          <label class="label">Card Width (mm)</label>
          <input id="cardWidth" class="input" type="number" min="50" max="120" step="0.1" value="85.6">
        </div>
        <div>
          <label class="label">Card Height (mm)</label>
          <input id="cardHeight" class="input" type="number" min="30" max="90" step="0.1" value="54">
        </div>
        <div>
          <label class="label">Paper Orientation</label>
          <select id="paperOrientation" class="input">
            <option value="portrait">Portrait</option>
            <option value="landscape">Landscape</option>
          </select>
        </div>
        <div class="flex items-end">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="includeBackSheet" type="checkbox" checked>
            Include back side page
          </label>
        </div>
      </div>

      <h3 class="text-base font-bold mt-6 mb-3">Card Data</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="label">Name</label>
          <input id="name" class="input" value="Employee Name">
        </div>
        <div>
          <label class="label">ID Number</label>
          <input id="idNumber" class="input" value="AO-2026-001">
        </div>
        <div>
          <label class="label">Designation</label>
          <input id="designation" class="input" value="Sales Manager">
        </div>
        <div>
          <label class="label">Department</label>
          <input id="department" class="input" value="Business Development">
        </div>
        <div>
          <label class="label">Company</label>
          <input id="company" class="input" value="School / Organization">
        </div>
        <div>
          <label class="label">Valid Till</label>
          <input id="validTill" class="input" type="date">
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="label">Photo Upload</label>
          <input id="photoUpload" class="input" type="file" accept="image/*" capture="user">
        </div>
        <div>
          <label class="label">Logo Upload</label>
          <input id="logoUpload" class="input" type="file" accept="image/*">
        </div>
        <div>
          <label class="label">Primary Color</label>
          <input id="primaryColor" class="input h-11 p-1" type="color" value="#1d4ed8">
        </div>
        <div>
          <label class="label">Text Color</label>
          <input id="textColor" class="input h-11 p-1" type="color" value="#ffffff">
        </div>
      </div>

      <div class="mt-5 grid sm:grid-cols-2 md:grid-cols-3 gap-3">
        <button id="saveRecordBtn" class="btn btn-subtle">Save Record</button>
        <button id="downloadPngBtn" class="btn btn-subtle">Download PNG</button>
        <button id="exportA4Btn" class="btn btn-primary">Export A4 PDF</button>
        <button id="exportA3Btn" class="btn btn-primary">Export A3 PDF</button>
      </div>
      <p id="statusMsg" class="text-xs text-slate-500 mt-3"></p>
    </section>

    <section class="space-y-6">
      <div class="panel p-5">
        <h2 class="text-lg font-bold mb-3">Live Preview</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="canvas-wrap">
            <p class="text-xs font-semibold text-slate-500 mb-2">Front</p>
            <canvas id="frontCanvas" width="860" height="540" class="w-full rounded-lg bg-white"></canvas>
          </div>
          <div class="canvas-wrap">
            <p class="text-xs font-semibold text-slate-500 mb-2">Back</p>
            <canvas id="backCanvas" width="860" height="540" class="w-full rounded-lg bg-white"></canvas>
          </div>
        </div>
      </div>

      <div class="panel p-5">
        <h2 class="text-lg font-bold mb-3">Saved Records</h2>
        <div id="recordsList" class="space-y-2 max-h-[260px] overflow-auto"></div>
      </div>

      <div class="panel p-5">
        <h2 class="text-lg font-bold mb-3">Enterprise Bulk Upload</h2>
        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="label">Job Name</label>
            <input id="bulkJobName" class="input" placeholder="March Employee Batch">
          </div>
          <div>
            <label class="label">Contact Name</label>
            <input id="bulkContactName" class="input" placeholder="HR Team">
          </div>
          <div>
            <label class="label">Contact Phone</label>
            <input id="bulkContactPhone" class="input" placeholder="+91...">
          </div>
          <div>
            <label class="label">Contact Email</label>
            <input id="bulkContactEmail" class="input" placeholder="ops@company.com">
          </div>
        </div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="downloadCsvTemplateBtn" class="btn btn-subtle">Download School CSV Template</button>
          <label class="btn btn-subtle cursor-pointer">
            Upload CSV
            <input id="bulkCsvUpload" type="file" accept=".csv,text/csv" class="hidden">
          </label>
        </div>
        <p id="bulkMsg" class="text-xs text-slate-500 mt-2">Upload CSV with school fields: studentName,admissionNo,className,section,schoolName,validTill (or generic employee fields).</p>
        <div class="mt-3 border rounded-lg overflow-auto max-h-[220px]">
          <table class="w-full data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Admission/ID</th>
                <th>Class</th>
                <th>Section</th>
                <th>School</th>
                <th>Valid Till</th>
              </tr>
            </thead>
            <tbody id="bulkRecordsTable"></tbody>
          </table>
        </div>
        <div class="mt-3 grid sm:grid-cols-2 gap-2">
          <button id="bulkExportA4Btn" class="btn btn-primary">Bulk Export A4 PDF</button>
          <button id="bulkExportA3Btn" class="btn btn-primary">Bulk Export A3 PDF</button>
          <button id="bulkSaveJobBtn" class="btn btn-subtle">Save Bulk Job (Server)</button>
          <button id="bulkClearBtn" class="btn btn-subtle">Clear Bulk Data</button>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
const STORAGE_KEY = 'id-card-studio-records-v2';
const frontCanvas = document.getElementById('frontCanvas');
const backCanvas = document.getElementById('backCanvas');
const fctx = frontCanvas.getContext('2d');
const bctx = backCanvas.getContext('2d');
const scratchFront = document.createElement('canvas');
const scratchBack = document.createElement('canvas');
scratchFront.width = frontCanvas.width;
scratchFront.height = frontCanvas.height;
scratchBack.width = backCanvas.width;
scratchBack.height = backCanvas.height;
const sfctx = scratchFront.getContext('2d');
const sbctx = scratchBack.getContext('2d');
let photoData = '';
let logoData = '';
let bulkRecords = [];
let lastExportFormat = 'a4';
let previewDrawToken = 0;

function byId(id) {
  return document.getElementById(id);
}

function value(id) {
  return byId(id).value;
}

function setStatus(msg, isError) {
  const el = byId('statusMsg');
  el.textContent = msg || '';
  el.style.color = isError ? '#b91c1c' : '#475569';
}

function setBulkMessage(msg, isError) {
  const el = byId('bulkMsg');
  el.textContent = msg || '';
  el.style.color = isError ? '#b91c1c' : '#475569';
}

function readFileAsDataUrl(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(String(reader.result || ''));
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function loadImageSafe(src) {
  return new Promise((resolve) => {
    if (!src) return resolve(null);
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = () => resolve(null);
    img.src = src;
  });
}

function currentDesignBase() {
  return {
    template: value('template'),
    cardWidth: Number(value('cardWidth') || 85.6),
    cardHeight: Number(value('cardHeight') || 54),
    paperOrientation: value('paperOrientation'),
    includeBackSheet: byId('includeBackSheet').checked,
    name: value('name'),
    idNumber: value('idNumber'),
    designation: value('designation'),
    department: value('department'),
    company: value('company'),
    validTill: value('validTill'),
    primaryColor: value('primaryColor'),
    textColor: value('textColor'),
    photoData,
    logoData
  };
}

async function drawCard(ctx, side, data) {
  const primary = data.primaryColor || '#1d4ed8';
  const textColor = data.textColor || '#ffffff';
  const template = data.template || 'corporate';
  const name = data.name || '';
  const idNumber = data.idNumber || '';
  const designation = data.designation || '';
  const department = data.department || '';
  const company = data.company || '';
  const validTill = data.validTill || '';

  const w = ctx.canvas.width;
  const h = ctx.canvas.height;
  ctx.clearRect(0, 0, w, h);
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, w, h);
  ctx.strokeStyle = '#d1d5db';
  ctx.lineWidth = 4;
  ctx.strokeRect(4, 4, w - 8, h - 8);

  ctx.fillStyle = primary;
  ctx.fillRect(0, 0, w, 104);
  ctx.fillStyle = textColor;
  ctx.font = 'bold 44px Arial';
  ctx.fillText(company || 'Arya Studio', 24, 66);

  if (template === 'student') {
    ctx.fillStyle = '#e0f2fe';
    ctx.fillRect(0, h - 96, w, 96);
  } else if (template === 'visitor') {
    ctx.fillStyle = '#fef3c7';
    ctx.fillRect(0, h - 96, w, 96);
  }

  if (side === 'front') {
    ctx.fillStyle = '#0f172a';
    ctx.font = 'bold 42px Arial';
    ctx.fillText(name || 'Employee Name', 232, 230);
    ctx.font = '28px Arial';
    ctx.fillStyle = '#334155';
    ctx.fillText(designation || 'Designation', 232, 274);
    ctx.fillText(department || 'Department', 232, 312);
    ctx.fillStyle = '#1e293b';
    ctx.font = 'bold 32px Arial';
    ctx.fillText(`ID: ${idNumber || '-'}`, 232, 366);
    ctx.font = '24px Arial';
    ctx.fillText(`Valid: ${validTill || 'N/A'}`, 232, 406);

    if (data.photoData) {
      const img = await loadImageSafe(data.photoData);
      if (img) {
        ctx.drawImage(img, 32, 150, 170, 220);
      } else {
        ctx.strokeStyle = '#94a3b8';
        ctx.setLineDash([8, 6]);
        ctx.strokeRect(32, 150, 170, 220);
        ctx.setLineDash([]);
        ctx.fillStyle = '#64748b';
        ctx.font = '20px Arial';
        ctx.fillText('PHOTO', 82, 266);
      }
    } else {
      ctx.strokeStyle = '#94a3b8';
      ctx.setLineDash([8, 6]);
      ctx.strokeRect(32, 150, 170, 220);
      ctx.setLineDash([]);
      ctx.fillStyle = '#64748b';
      ctx.font = '20px Arial';
      ctx.fillText('PHOTO', 82, 266);
    }
  } else {
    ctx.fillStyle = '#0f172a';
    ctx.font = 'bold 36px Arial';
    ctx.fillText('Back Side', 26, 168);
    ctx.font = '24px Arial';
    ctx.fillStyle = '#334155';
    ctx.fillText('If found, return to issuing organization.', 26, 220);
    ctx.fillText('Email: admin@school.org', 26, 260);
    ctx.fillText('Phone: +91-XXXXXXXXXX', 26, 300);
    ctx.fillText('This card is property of company.', 26, 340);
    ctx.fillText('Misuse is prohibited.', 26, 380);
  }

  if (data.logoData) {
    const logo = await loadImageSafe(data.logoData);
    if (logo) {
      ctx.drawImage(logo, w - 126, 18, 100, 68);
      return;
    }
  }
  {
    ctx.fillStyle = 'rgba(255,255,255,0.82)';
    ctx.fillRect(w - 130, 16, 102, 70);
    ctx.fillStyle = '#1e3a8a';
    ctx.font = 'bold 16px Arial';
    ctx.fillText('LOGO', w - 98, 58);
  }
}

async function renderPreview() {
  const token = ++previewDrawToken;
  const data = currentDesignBase();
  await drawCard(fctx, 'front', data);
  if (token !== previewDrawToken) return;
  await drawCard(bctx, 'back', data);
}

function getFormData() {
  return {
    id: `rec-${Date.now()}`,
    quantity: Number(value('quantity') || 1),
    createdAt: new Date().toISOString(),
    ...currentDesignBase()
  };
}

function applyFormData(data) {
  byId('template').value = data.template || 'corporate';
  byId('quantity').value = data.quantity || 24;
  byId('cardWidth').value = data.cardWidth || 85.6;
  byId('cardHeight').value = data.cardHeight || 54;
  byId('paperOrientation').value = data.paperOrientation || 'portrait';
  byId('includeBackSheet').checked = data.includeBackSheet !== false;
  byId('name').value = data.name || '';
  byId('idNumber').value = data.idNumber || '';
  byId('designation').value = data.designation || '';
  byId('department').value = data.department || '';
  byId('company').value = data.company || '';
  byId('validTill').value = data.validTill || '';
  byId('primaryColor').value = data.primaryColor || '#1d4ed8';
  byId('textColor').value = data.textColor || '#ffffff';
  photoData = data.photoData || '';
  logoData = data.logoData || '';
  renderPreview();
}

function loadRecords() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  } catch (err) {
    return [];
  }
}

function saveRecords(records) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
}

function renderRecords() {
  const records = loadRecords();
  const box = byId('recordsList');
  if (!records.length) {
    box.innerHTML = '<p class="text-sm text-slate-500">No saved records.</p>';
    return;
  }
  box.innerHTML = records.map((item) => `
    <div class="border rounded-lg p-3 flex items-center justify-between gap-3">
      <div>
        <p class="font-semibold text-sm">${item.name || 'Unnamed'} · ${item.idNumber || '-'}</p>
        <p class="text-xs text-slate-500">${item.company || '-'} · Qty ${item.quantity || '-'}</p>
      </div>
      <div class="flex items-center gap-2">
        <button data-load="${item.id}" class="btn btn-subtle !py-1 !px-2 text-xs">Load</button>
        <button data-del="${item.id}" class="btn btn-subtle !py-1 !px-2 text-xs text-red-700">Delete</button>
      </div>
    </div>
  `).join('');

  box.querySelectorAll('[data-load]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const rec = records.find((r) => r.id === btn.getAttribute('data-load'));
      if (rec) {
        applyFormData(rec);
        setStatus('Record loaded.', false);
      }
    });
  });

  box.querySelectorAll('[data-del]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-del');
      saveRecords(records.filter((r) => r.id !== id));
      renderRecords();
      setStatus('Record deleted.', false);
    });
  });
}

function mapBulkRow(row) {
  const normalized = {};
  Object.keys(row || {}).forEach((key) => {
    const nk = String(key).toLowerCase().replace(/[\s_\-]/g, '');
    normalized[nk] = row[key];
  });
  const pick = (...keys) => {
    for (const k of keys) {
      if (normalized[k] !== undefined && normalized[k] !== null) {
        const text = String(normalized[k]).trim();
        if (text) return text;
      }
    }
    return '';
  };
  const className = pick('classname', 'class', 'standard', 'grade');
  const section = pick('section', 'sec', 'division');
  const school = pick('schoolname', 'school', 'institution', 'company', 'organization', 'organisation');
  const role = pick('designation', 'role');
  const dept = pick('department', 'dept');
  return {
    name: pick('studentname', 'name', 'fullname', 'employeename'),
    idNumber: pick('admissionno', 'rollno', 'studentid', 'idnumber', 'id', 'employeeid'),
    designation: className || role,
    department: section || dept,
    company: school || 'Arya Studio',
    validTill: pick('validtill', 'validto', 'expiry')
  };
}

function renderBulkTable() {
  const tbody = byId('bulkRecordsTable');
  if (!bulkRecords.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-slate-500 text-xs py-3">No bulk records loaded.</td></tr>';
    return;
  }
  tbody.innerHTML = bulkRecords.slice(0, 500).map((record) => `
    <tr>
      <td>${record.name || '-'}</td>
      <td>${record.idNumber || '-'}</td>
      <td>${record.designation || '-'}</td>
      <td>${record.department || '-'}</td>
      <td>${record.company || '-'}</td>
      <td>${record.validTill || '-'}</td>
    </tr>
  `).join('');
}

function getCsvTemplate() {
  return [
    'studentName,admissionNo,className,section,schoolName,validTill',
    'Aarav Sharma,STU-001,8,A,Sunrise Public School,2027-03-31',
    'Ananya Verma,STU-002,8,B,Sunrise Public School,2027-03-31',
    'Rohan Gupta,STU-003,9,A,Sunrise Public School,2027-03-31'
  ].join('\\n');
}

function downloadCsvTemplate() {
  const blob = new Blob([getCsvTemplate()], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'id-card-bulk-template.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function parseBulkCsv(file) {
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: (results) => {
      if (results.errors && results.errors.length) {
        setBulkMessage(`CSV error: ${results.errors[0].message}`, true);
        return;
      }
      const rows = Array.isArray(results.data) ? results.data : [];
      bulkRecords = rows.map(mapBulkRow).filter((record) => record.name || record.idNumber);
      renderBulkTable();
      setBulkMessage(`Loaded ${bulkRecords.length} records from CSV.`, false);
    },
    error: (err) => {
      setBulkMessage(err.message || 'Failed to parse CSV.', true);
    }
  });
}

async function renderRecordToImages(record) {
  const merged = {
    ...currentDesignBase(),
    ...record,
    photoData: currentDesignBase().photoData,
    logoData: currentDesignBase().logoData
  };
  await drawCard(sfctx, 'front', merged);
  await drawCard(sbctx, 'back', merged);
  return {
    front: scratchFront.toDataURL('image/png'),
    back: scratchBack.toDataURL('image/png')
  };
}

async function exportRecordsPdf(format, records) {
  if (!records.length) {
    setStatus('No records available for export.', true);
    return;
  }
  const { jsPDF } = window.jspdf;
  const cardW = Number(value('cardWidth') || 85.6);
  const cardH = Number(value('cardHeight') || 54);
  const orientation = value('paperOrientation') || 'portrait';
  const includeBack = byId('includeBackSheet').checked;
  if (cardW <= 0 || cardH <= 0) {
    setStatus('Invalid card size values.', true);
    return;
  }

  const paperMap = { a4: [210, 297], a3: [297, 420] };
  const base = paperMap[String(format).toLowerCase()] || paperMap.a4;
  const pageSize = orientation === 'landscape' ? [base[1], base[0]] : [base[0], base[1]];
  const doc = new jsPDF({ unit: 'mm', format: pageSize });
  const pageW = pageSize[0];
  const pageH = pageSize[1];
  const margin = 8;
  const gap = 3;
  const cols = Math.max(1, Math.floor((pageW - (margin * 2) + gap) / (cardW + gap)));
  const rows = Math.max(1, Math.floor((pageH - (margin * 2) + gap) / (cardH + gap)));
  const perPage = cols * rows;

  for (let idx = 0; idx < records.length; idx += 1) {
    const record = records[idx];
    if (idx > 0 && idx % perPage === 0) doc.addPage();
    const indexOnPage = idx % perPage;
    const row = Math.floor(indexOnPage / cols);
    const col = indexOnPage % cols;
    const x = margin + (col * (cardW + gap));
    const y = margin + (row * (cardH + gap));
    const images = await renderRecordToImages(record);
    doc.addImage(images.front, 'PNG', x, y, cardW, cardH);
  }

  if (includeBack) {
    doc.addPage();
    for (let idx = 0; idx < records.length; idx += 1) {
      const record = records[idx];
      if (idx > 0 && idx % perPage === 0) doc.addPage();
      const indexOnPage = idx % perPage;
      const row = Math.floor(indexOnPage / cols);
      const col = indexOnPage % cols;
      const x = margin + (col * (cardW + gap));
      const y = margin + (row * (cardH + gap));
      const images = await renderRecordToImages(record);
      doc.addImage(images.back, 'PNG', x, y, cardW, cardH);
    }
  }

  lastExportFormat = String(format).toLowerCase();
  doc.save(`id-cards-${format}-${Date.now()}.pdf`);
  setStatus(`Exported ${records.length} cards on ${format.toUpperCase()} (${orientation}) PDF.`, false);
}

async function saveBulkJobToServer() {
  if (!bulkRecords.length) {
    setBulkMessage('Upload CSV first.', true);
    return;
  }
  try {
    const response = await fetch('/api/id-card/jobs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        jobName: value('bulkJobName'),
        contactName: value('bulkContactName'),
        contactPhone: value('bulkContactPhone'),
        contactEmail: value('bulkContactEmail'),
        paperSize: lastExportFormat,
        orientation: value('paperOrientation'),
        cardWidthMm: Number(value('cardWidth') || 85.6),
        cardHeightMm: Number(value('cardHeight') || 54),
        includeBackSheet: byId('includeBackSheet').checked,
        templateName: value('template'),
        records: bulkRecords,
        notes: 'Created from Arya Studio ID Suite'
      })
    });
    const data = await response.json();
    if (!data.success) {
      throw new Error(data.message || 'Failed to save job.');
    }
    setBulkMessage(`Bulk job saved. Job ID: ${data.jobId} (Records: ${data.recordsCount})`, false);
  } catch (err) {
    setBulkMessage(err.message || 'Failed to save bulk job.', true);
  }
}

function bind() {
  const watchIds = [
    'template', 'quantity', 'cardWidth', 'cardHeight', 'paperOrientation', 'includeBackSheet',
    'name', 'idNumber', 'designation', 'department', 'company', 'validTill', 'primaryColor', 'textColor'
  ];
  watchIds.forEach((id) => {
    const el = byId(id);
    const ev = el.tagName === 'SELECT' || el.type === 'checkbox' ? 'change' : 'input';
    el.addEventListener(ev, () => { renderPreview(); });
  });

  byId('photoUpload').addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    photoData = await readFileAsDataUrl(file);
    await renderPreview();
  });

  byId('logoUpload').addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    logoData = await readFileAsDataUrl(file);
    await renderPreview();
  });

  byId('saveRecordBtn').addEventListener('click', () => {
    const record = getFormData();
    const records = loadRecords();
    records.unshift(record);
    saveRecords(records.slice(0, 150));
    renderRecords();
    setStatus('Record saved locally.', false);
  });

  byId('downloadPngBtn').addEventListener('click', async () => {
    await renderPreview();
    const a = document.createElement('a');
    a.href = frontCanvas.toDataURL('image/png');
    a.download = `id-card-front-${Date.now()}.png`;
    a.click();
    setStatus('PNG downloaded.', false);
  });

  byId('exportA4Btn').addEventListener('click', async () => {
    const qty = Math.max(1, Number(value('quantity') || 1));
    const base = currentDesignBase();
    const records = Array.from({ length: qty }).map(() => ({ ...base }));
    await exportRecordsPdf('a4', records);
  });
  byId('exportA3Btn').addEventListener('click', async () => {
    const qty = Math.max(1, Number(value('quantity') || 1));
    const base = currentDesignBase();
    const records = Array.from({ length: qty }).map(() => ({ ...base }));
    await exportRecordsPdf('a3', records);
  });

  byId('downloadCsvTemplateBtn').addEventListener('click', downloadCsvTemplate);
  byId('bulkCsvUpload').addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    parseBulkCsv(file);
  });
  byId('bulkExportA4Btn').addEventListener('click', async () => { await exportRecordsPdf('a4', bulkRecords); });
  byId('bulkExportA3Btn').addEventListener('click', async () => { await exportRecordsPdf('a3', bulkRecords); });
  byId('bulkSaveJobBtn').addEventListener('click', saveBulkJobToServer);
  byId('bulkClearBtn').addEventListener('click', () => {
    bulkRecords = [];
    renderBulkTable();
    setBulkMessage('Bulk records cleared.', false);
  });
}

bind();
renderPreview();
renderRecords();
renderBulkTable();
</script>
</body>
</html>
