<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>Product CMS | Arya Overseas Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="/assets/theme.css">
<style>
.loading {
  opacity: 0.6;
  pointer-events: none;
}
.success-message {
  animation: slideDown 0.3s ease-out;
}
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</head>

<body class="bg-gray-100 min-h-screen">

<header class="bg-gray-900 text-white px-4 sm:px-6 py-4 shadow-lg">
  <div class="max-w-7xl mx-auto flex justify-between items-center">
    <h1 class="text-xl font-bold">Product CMS - Admin Panel</h1>
    <a href="/" class="text-sm underline hover:text-blue-300 transition-colors">View Website</a>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 sm:p-6">

  <!-- Success/Error Messages -->
  <div id="messageContainer" class="mb-6"></div>

  <!-- ADD PRODUCT -->
  <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
    <h2 class="text-2xl font-semibold mb-6 text-gray-800">Add New Product</h2>

    <form id="productForm" onsubmit="event.preventDefault(); addProduct();">
      <div class="space-y-4">
        <div>
          <label class="block font-medium mb-2 text-gray-700">Product Title *</label>
          <input id="title" type="text" placeholder="e.g., Custom ID Cards"
            class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition-colors"
            required>
        </div>

        <div>
          <label class="block font-medium mb-2 text-gray-700">Short Description (for homepage)</label>
          <input id="shortDesc" type="text" placeholder="Brief description shown on homepage"
            class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition-colors">
        </div>

        <div>
          <label class="block font-medium mb-2 text-gray-700">Full Description *</label>
          <textarea id="description" placeholder="Detailed product description..."
            rows="5" class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition-colors resize-none"
            required></textarea>
        </div>

        <div>
          <label class="block font-medium mb-2 text-gray-700">Product Image *</label>
          <input type="file" id="imageUpload" accept="image/*"
            class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:outline-none transition-colors"
            required>
          <p class="text-xs text-gray-500 mt-1">Max file size: 5MB. Supported formats: JPG, PNG, GIF, WebP</p>
          <div id="imagePreview" class="mt-4 hidden">
            <img id="previewImg" src="" alt="Preview" class="max-w-xs rounded-lg border-2 border-gray-300 shadow-md">
          </div>
        </div>

        <div>
          <label class="block font-medium mb-3 text-gray-700">MOQ-Based Pricing *</label>
          <div id="pricingTiers" class="space-y-4 mb-4">
            <div class="pricing-tier p-4 border-2 border-gray-200 rounded-lg bg-gray-50">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                  <label class="text-sm text-gray-600 mb-1 block">Min Quantity *</label>
                  <input type="number" placeholder="e.g., 100" min="1"
                    class="w-full border rounded-lg p-2 tier-min focus:border-blue-500 focus:outline-none" required>
                </div>
                <div>
                  <label class="text-sm text-gray-600 mb-1 block">Max Quantity (optional)</label>
                  <input type="number" placeholder="e.g., 500" min="1"
                    class="w-full border rounded-lg p-2 tier-max focus:border-blue-500 focus:outline-none">
                </div>
                <div>
                  <label class="text-sm text-gray-600 mb-1 block">Price per unit (₹) *</label>
                  <input type="number" placeholder="e.g., 25.00" step="0.01" min="0"
                    class="w-full border rounded-lg p-2 tier-price focus:border-blue-500 focus:outline-none" required>
                </div>
                <div>
                  <button type="button" onclick="removePricingTier(this)" 
                    class="w-full text-red-600 px-4 py-2 border border-red-300 rounded-lg hover:bg-red-50 transition-colors font-medium">
                    Remove
                  </button>
                </div>
              </div>
            </div>
          </div>
          <button type="button" onclick="addPricingTier()" 
            class="text-blue-600 text-sm font-medium hover:text-blue-700 transition-colors flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Another Pricing Tier
          </button>
        </div>

        <button type="submit" id="submitBtn"
          class="bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-800 w-full transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
          <span id="submitText">Save Product</span>
          <span id="submitLoading" class="hidden">Saving...</span>
        </button>
      </div>
    </form>
  </div>

  <!-- PRODUCT LIST -->
  <div class="bg-white p-6 rounded-xl shadow-lg">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold text-gray-800">All Products</h2>
      <button onclick="loadProducts()" 
        class="text-blue-600 hover:text-blue-700 font-medium flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Refresh
      </button>
    </div>

    <div id="productList" class="space-y-4">
      <div class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-700"></div>
        <p class="text-gray-600 mt-2">Loading products...</p>
      </div>
    </div>
  </div>

</main>

<script>
const API_BASE = window.location.origin;

// Show message
function showMessage(message, type = 'success') {
  const container = document.getElementById('messageContainer');
  const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
  container.innerHTML = `
    <div class="${bgColor} text-white px-6 py-4 rounded-lg shadow-lg success-message flex justify-between items-center">
      <span>${message}</span>
      <button onclick="this.parentElement.remove()" class="ml-4 hover:opacity-80">×</button>
    </div>
  `;
  setTimeout(() => container.innerHTML = '', 5000);
}

// Image preview
document.getElementById("imageUpload").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (file) {
    if (file.size > 5 * 1024 * 1024) {
      showMessage('Image size must be less than 5MB', 'error');
      this.value = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById("previewImg").src = e.target.result;
      document.getElementById("imagePreview").classList.remove("hidden");
    };
    reader.readAsDataURL(file);
  }
});

// Pricing tiers
function addPricingTier() {
  const container = document.getElementById("pricingTiers");
  const tier = document.createElement("div");
  tier.className = "pricing-tier p-4 border-2 border-gray-200 rounded-lg bg-gray-50";
  tier.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Min Quantity *</label>
        <input type="number" placeholder="e.g., 100" min="1"
          class="w-full border rounded-lg p-2 tier-min focus:border-blue-500 focus:outline-none" required>
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Max Quantity (optional)</label>
        <input type="number" placeholder="e.g., 500" min="1"
          class="w-full border rounded-lg p-2 tier-max focus:border-blue-500 focus:outline-none">
      </div>
      <div>
        <label class="text-sm text-gray-600 mb-1 block">Price per unit (₹) *</label>
        <input type="number" placeholder="e.g., 25.00" step="0.01" min="0"
          class="w-full border rounded-lg p-2 tier-price focus:border-blue-500 focus:outline-none" required>
      </div>
      <div>
        <button type="button" onclick="removePricingTier(this)" 
          class="w-full text-red-600 px-4 py-2 border border-red-300 rounded-lg hover:bg-red-50 transition-colors font-medium">
          Remove
        </button>
      </div>
    </div>
  `;
  container.appendChild(tier);
}

function removePricingTier(btn) {
  const container = document.getElementById("pricingTiers");
  if (container.children.length > 1) {
    btn.closest(".pricing-tier").remove();
  } else {
    showMessage('At least one pricing tier is required', 'error');
  }
}

// Add product
async function addProduct() {
  const form = document.getElementById('productForm');
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submitText');
  const submitLoading = document.getElementById('submitLoading');

  const title = document.getElementById("title").value.trim();
  const shortDesc = document.getElementById("shortDesc").value.trim();
  const description = document.getElementById("description").value.trim();
  const imageFile = document.getElementById("imageUpload").files[0];

  if (!title || !description) {
    showMessage('Title and description are required', 'error');
    return;
  }

  if (!imageFile) {
    showMessage('Please upload a product image', 'error');
    return;
  }

  // Get pricing tiers
  const tiers = Array.from(document.querySelectorAll(".pricing-tier")).map(tier => {
    const min = parseInt(tier.querySelector(".tier-min").value) || 0;
    const max = tier.querySelector(".tier-max").value ? parseInt(tier.querySelector(".tier-max").value) : null;
    const price = parseFloat(tier.querySelector(".tier-price").value) || 0;
    
    if (min === 0 || price === 0) return null;
    
    return { min, max, price };
  }).filter(t => t !== null);

  if (tiers.length === 0) {
    showMessage('Please add at least one pricing tier', 'error');
    return;
  }

  // Create FormData
  const formData = new FormData();
  formData.append('title', title);
  formData.append('shortDesc', shortDesc);
  formData.append('description', description);
  formData.append('image', imageFile);
  formData.append('pricing', JSON.stringify(tiers));

  // Disable form
  form.classList.add('loading');
  submitBtn.disabled = true;
  submitText.classList.add('hidden');
  submitLoading.classList.remove('hidden');

  try {
    const response = await fetch(`${API_BASE}/api/products`, {
      method: 'POST',
      body: formData
    });

    const data = await response.json();

    if (data.success) {
      showMessage('Product added successfully!', 'success');
      form.reset();
      document.getElementById("imagePreview").classList.add("hidden");
      loadProducts();
    } else {
      showMessage(data.message || 'Error adding product', 'error');
    }
  } catch (error) {
    console.error('Error:', error);
    showMessage('Network error. Please try again.', 'error');
  } finally {
    form.classList.remove('loading');
    submitBtn.disabled = false;
    submitText.classList.remove('hidden');
    submitLoading.classList.add('hidden');
  }
}

// Load products
async function loadProducts() {
  const list = document.getElementById("productList");
  list.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-700"></div><p class="text-gray-600 mt-2">Loading products...</p></div>';

  try {
    const response = await fetch(`${API_BASE}/api/products`);
    const data = await response.json();

    if (data.success && data.products && data.products.length > 0) {
      list.innerHTML = '';
      data.products.forEach((p, i) => {
        const imageSrc = p.image ? `${API_BASE}${p.image}` : '/assets/veom-logo.png';
        const pricingInfo = p.pricing && p.pricing.length > 0 
          ? `${p.pricing.length} pricing tier(s)` 
          : "No pricing set";
        
        const productCard = document.createElement('div');
        productCard.className = 'border-2 border-gray-200 p-4 rounded-lg flex flex-col md:flex-row gap-4 items-start hover:shadow-md transition-shadow';
        productCard.innerHTML = `
          <img src="${imageSrc}" alt="${p.title}" class="w-24 h-24 md:w-32 md:h-32 object-cover rounded-lg flex-shrink-0">
          <div class="flex-1 min-w-0">
            <h3 class="text-lg font-bold text-gray-900 mb-1">${p.title}</h3>
            <p class="text-sm text-gray-600 mb-2 line-clamp-2">${p.shortDesc || p.description?.substring(0, 100) || ''}</p>
            <p class="text-xs text-blue-600 mb-1">${pricingInfo}</p>
            <p class="text-xs text-gray-500">ID: ${p.id}</p>
          </div>
          <div class="flex gap-2 flex-shrink-0">
            <a href="/product/${p.id}" target="_blank"
               class="text-blue-600 text-sm px-4 py-2 border border-blue-300 rounded-lg hover:bg-blue-50 transition-colors font-medium">
              View
            </a>
            <button onclick="deleteProduct('${p.id}')"
              class="text-red-600 text-sm px-4 py-2 border border-red-300 rounded-lg hover:bg-red-50 transition-colors font-medium">
              Delete
            </button>
          </div>
        `;
        list.appendChild(productCard);
      });
    } else {
      list.innerHTML = '<li class="text-gray-500 italic text-center py-8">No products added yet</li>';
    }
  } catch (error) {
    console.error('Error loading products:', error);
    list.innerHTML = '<li class="text-red-500 text-center py-8">Error loading products. Please refresh the page.</li>';
  }
}

// Delete product
async function deleteProduct(id) {
  if (!confirm('Are you sure you want to delete this product?')) return;

  try {
    const response = await fetch(`${API_BASE}/api/products/${id}`, {
      method: 'DELETE'
    });

    const data = await response.json();

    if (data.success) {
      showMessage('Product deleted successfully', 'success');
      loadProducts();
    } else {
      showMessage(data.message || 'Error deleting product', 'error');
    }
  } catch (error) {
    console.error('Error:', error);
    showMessage('Network error. Please try again.', 'error');
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', loadProducts);
</script>

</body>
</html>
